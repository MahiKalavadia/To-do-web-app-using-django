{% extends 'base.html' %}

{% block title %}
<title>Dashboard | To-Do App</title>
{% endblock title %}

{% block content %}
<div class="container mt-4">
  <!--STATS-->
  <div class="row mb-4">
      <div class="col-md-2">
    <div class="card shadow-sm text-center">
      <div class="card-body">
        <small class="text-muted">Total</small>
        <h4>{{ total_tasks }}</h4>
      </div>
    </div>
  </div>

  <div class="col-md-2">
    <div class="card shadow-sm text-center border-success">
      <div class="card-body text-success">
        <small>Completed</small>
        <h4>{{ completed_tasks }}</h4>
      </div>
    </div>
  </div>

  <div class="col-md-2">
    <div class="card shadow-sm text-center border-warning">
      <div class="card-body text-warning">
        <small>Pending</small>
        <h4>{{ pending_tasks }}</h4>
      </div>
    </div>
  </div>

  <div class="col-md-2">
    <div class="card shadow-sm text-center border-danger">
      <div class="card-body text-danger">
        <small>High</small>
        <h4>{{ high_priority }}</h4>
      </div>
    </div>
  </div>

  <div class="col-md-2">
    <div class="card shadow-sm text-center border-info">
      <div class="card-body text-info">
        <small>Medium</small>
        <h4>{{ medium_priority }}</h4>
      </div>
    </div>
  </div>

  <div class="col-md-2">
    <div class="card shadow-sm text-center border-secondary">
      <div class="card-body text-secondary">
        <small>Low</small>
        <h4>{{ low_priority }}</h4>
      </div>
    </div>
  </div>
  </div>
  <!--Search and filter-->
  <form method="get" class="row g-2 mb-4">
  <!--Search-->
    <div class="col-md-3">
      <input type="text" name="q" class="form-control"
             placeholder="Search tasks..."
             value="{{ query }}">
    </div>
    <!--Status-->
    <div class="col-md-2">
      <select name="status" class="form-select">
        <option value="">All Status</option>
        <option value="completed" {% if filter_status == 'completed' %}selected{% endif %}>Completed</option>
        <option value="pending" {% if filter_status == 'pending' %}selected{% endif %}>Pending</option>
      </select>
    </div>
    <!--Priority-->
    <div class="col-md-2">
      <select name="priority" class="form-select">
        <option value="">All Priority</option>
        <option value="H" {% if filter_priority == 'H' %}selected{% endif %}>High</option>
        <option value="M" {% if filter_priority == 'M' %}selected{% endif %}>Medium</option>
        <option value="L" {% if filter_priority == 'L' %}selected{% endif %}>Low</option>
      </select>
    </div>
    <!--DUe date filter-->
    <div class="col-md-2">
      <select name="due" class="form-select">
        <option value="">All Dates</option>
        <option value="today" {% if filter_due == 'today' %}selected{% endif %}>Today</option>
        <option value="overdue" {% if filter_due == 'overdue' %}selected{% endif %}>Overdue</option>
        <option value="this_week" {% if filter_due == 'this_week' %}selected{% endif %}>This Week</option>
      </select>
    </div>
    <!--Sort-->
    <div class="col-md-2">
      <select name="sort" class="form-select">
        <option value="asc" {% if sort == 'asc' %}selected{% endif %}>Due ↑</option>
        <option value="desc" {% if sort == 'desc' %}selected{% endif %}>Due ↓</option>
      </select>
    </div>
    <div class="col-md-1">
      <button class="btn btn-primary w-100">Go</button>
    </div>

  </form>
  <!-- Add Task -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>Your Tasks</h4>
    <a href="{% url 'create_task' %}" class="btn btn-success">
      + Add Task
    </a>
  </div>

  <!-- Task List -->
  <div class="card shadow-sm">
    <div class="card-body">

      {% if tasks %}
      <table class="table table-hover align-middle">
        <thead>
          <tr>
            <th>Mark as completed</th>
            <th>Task</th>
            <th>Actions</th>
          </tr>
        </thead>

        <tbody>
        {% for task in tasks %}
          <tr class="{% if task.due_date and task.due_date < today and not task.completed %}table-danger{% endif %}">
            <!-- Checkbox -->
           <td>
           <form action="{% url 'toggle_task' task.id %}" method="POST">
           {% csrf_token %}
           <input type="checkbox" name="completed"
              onchange="this.form.submit()"
             {% if task.completed %}checked{% endif %}>
           </form>
           </td>

            <!-- Task Title -->
            <td>
              {% if task.completed %}
                <del class="text-muted">{{ task.title }}</del>
              {% else %}
                {{ task.title }}
              {% endif %}
            </td>
            <!--Due date-->
            <td>
              {% if task.due_date %}
                {{ task.due_date }}
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>
            <!--Priority-->
            <td>
              {% if task.priority == 'H' %}
                <span class="badge bg-danger">High</span>
              {% elif task.priority == 'M' %}
                <span class="badge bg-warning">Medium</span>
              {% else %}
                <span class="badge bg-secondary">Low</span>
              {% endif %}
            </td>

            <!-- Actions -->
            <td>
              <a href="{% url 'update_task' task.id %}"
                 class="btn btn-sm btn-warning">
                Edit
              </a>

              <a href="{% url 'delete_task' task.id %}"
                 class="btn btn-sm btn-danger"
                 onclick="return confirm('Are you sure?')">
                Delete
              </a>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
      <!--Pagination-->
            <nav>
        <ul class="pagination justify-content-center">
          {% if tasks.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page={{ tasks.previous_page_number }}">Previous</a>
            </li>
          {% endif %}

          <li class="page-item disabled">
            <span class="page-link">
              Page {{ tasks.number }} of {{ tasks.paginator.num_pages }}
            </span>
          </li>

          {% if tasks.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ tasks.next_page_number }}">Next</a>
            </li>
          {% endif %}
        </ul>
      </nav>
      {% else %}
        <p class="text-muted mb-0">No tasks yet. Click “Add Task”.</p>
      {% endif %}

    </div>
  </div>

</div>

{% endblock content %}
